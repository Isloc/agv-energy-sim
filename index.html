<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador AGV ‚Äî React + Framer Motion (sin build)</title>

  <!-- Simple styles (educativo, colores vivos) -->
  <style>
    :root{
      --bg:#f7fbff;
      --card:#fff;
      --accent:#2563eb;
      --accent-2:#06b6d4;
      --muted:#64748b;
      --glass: rgba(255,255,255,0.85);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,#f0f9ff 0%, #fbf7ff 100%);
      color:#0f172a;
    }
    header{padding:20px 26px;border-bottom:1px solid rgba(15,23,42,0.06)}
    h1{margin:0;font-size:22px}
    .subtitle{margin-top:6px;color:var(--muted)}

    .layout{display:grid;grid-template-columns:320px 1fr 360px;gap:18px;padding:18px;align-items:start}
    .panel{background:var(--glass);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(15,23,42,0.06);border:1px solid rgba(15,23,42,0.04)}
    .card{background:var(--card);padding:10px;border-radius:8px;margin-bottom:12px}
    label{display:block;margin:6px 0;font-size:13px;color:#0f172a}
    input[type=number]{width:120px;padding:6px;border-radius:6px;border:1px solid #e6eef8;background:#fbfdff}
    .pkgRow{display:flex;gap:8px}
    .panel-actions{display:flex;gap:8px;margin-top:10px}
    button{cursor:pointer;padding:10px 12px;border-radius:8px;border:0;font-weight:600}
    .primary{background:var(--accent);color:#fff}
    .muted{background:#f1f5f9;color:var(--muted);border:1px solid rgba(15,23,42,0.04)}
    .panel-left{min-height:560px}
    .panel-right{min-height:560px}
    .panel-center{min-height:560px;display:flex;flex-direction:column;align-items:center}
    .canvasWrap{background:linear-gradient(180deg,#ffffff,#f3f8ff);padding:10px;border-radius:10px;border:1px dashed rgba(37,99,235,0.12);box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); width:100%}
    .svgCanvas{width:100%;height:520px;display:block}
    .animInfo{margin-top:10px;display:flex;gap:18px;color:var(--muted);font-size:14px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    table th{background:#eef2ff;padding:6px;text-align:left}
    table td{padding:6px;border-top:1px solid #f1f5f9}
    footer{text-align:center;padding:12px;color:var(--muted);font-size:13px;margin-top:8px}
    @media (max-width:1100px){
      .layout{grid-template-columns: 1fr; padding:12px}
      .panel-center{order:2}
      .panel-right{order:3}
      .panel-left{order:1}
    }
    .badge {display:inline-block;padding:4px 8px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-weight:700;font-size:12px}
    .robot-animated { transition: all 0.8s ease-in-out; }
  </style>
</head>
<body>
  <header>
    <h1>ü§ñ Simulador AGV ‚Äî Laboratorio Interactivo (React)</h1>
    <p class="subtitle">Animaciones fluidas y gr√°ficos con Chart.js ‚Äî abre el archivo y prueba.</p>
  </header>

  <div id="root"></div>

  <!-- CDN libs -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Babel in-browser for JSX (OK para prototipo local) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- App code (JSX) -->
  <script type="text/babel">

const { useState, useEffect, useRef } = React;

/* ---------- UTIL / PHYSICS (ported from your JS) ---------- */
const g = 9.81;

function calcElevatorEnergy(params){
  const motor = params.elevator_power * params.elevator_time;
  const standby = params.standby_power * params.elevator_time;
  return (motor + standby) / 3600 / 1000;
}

function calcPhysics(m, params){
  const friction = params.friction_coeff * m * g;
  const tractionAccel = m * params.max_acceleration + friction;
  const tractionConst = friction;
  const powerAccel = tractionAccel * params.max_velocity;
  const powerConst = tractionConst * params.max_velocity;
  return { friction, tractionAccel, tractionConst, powerAccel, powerConst };
}

function calcSegment(dist, m, params){
  const accelDist = (params.max_velocity ** 2) / (2 * params.max_acceleration);
  const brakeDist = accelDist;
  let accelTime, cruiseTime, brakeTime, cruiseDist;
  if (dist <= accelDist + brakeDist){
    const reachedV = Math.sqrt(params.max_acceleration * dist);
    accelTime = reachedV / params.max_acceleration;
    brakeTime = accelTime;
    cruiseTime = 0; cruiseDist = 0;
  } else {
    accelTime = params.max_velocity / params.max_acceleration;
    brakeTime = accelTime;
    cruiseDist = dist - accelDist - brakeDist;
    cruiseTime = cruiseDist / params.max_velocity;
  }
  const totalTime = accelTime + cruiseTime + brakeTime;
  const phys = calcPhysics(m, params);
  const e_accel = (phys.tractionAccel * accelDist) / params.propulsion_efficiency / 1000 / 3600;
  const e_cruise = (phys.tractionConst * (cruiseDist||0)) / params.propulsion_efficiency / 1000 / 3600;
  const e_brake = (phys.tractionConst * brakeDist) / params.propulsion_efficiency / 1000 / 3600;
  const e_standby = (params.standby_power / 1000) * (totalTime / 3600);
  return { totalTime, accelTime, cruiseTime, brakeTime, e_accel, e_cruise, e_brake, e_standby };
}

function permutations(arr){
  if(arr.length<=1) return [arr];
  const out=[];
  for(let i=0;i<arr.length;i++){
    const rest = arr.slice(0,i).concat(arr.slice(i+1));
    for(const p of permutations(rest)) out.push([arr[i],...p]);
  }
  return out;
}

/* ---------- React components ---------- */

function Controls({ params, setParams, onStart, onReset, speedScale, setSpeedScale }){
  function update(k, v){ setParams(prev => ({...prev, [k]: Number(v)})); }
  return (
    <aside className="panel panel-left">
      <h2>‚öôÔ∏è Par√°metros</h2>

      <div className="card">
        <h3>Par√°metros del Robot</h3>
        <label>Masa robot (kg) <input type="number" value={params.mass_robot} onChange={e=>update('mass_robot', e.target.value)} /></label>
        <label>Masa paquete (kg) <input type="number" value={params.mass_package} onChange={e=>update('mass_package', e.target.value)} /></label>
        <label>Velocidad m√°x (m/s) <input type="number" step="0.1" value={params.max_velocity} onChange={e=>update('max_velocity', e.target.value)} /></label>
        <label>Aceleraci√≥n m√°x (m/s¬≤) <input type="number" step="0.1" value={params.max_acceleration} onChange={e=>update('max_acceleration', e.target.value)} /></label>
        <label>Coef. fricci√≥n <input type="number" step="0.01" value={params.friction_coeff} onChange={e=>update('friction_coeff', e.target.value)} /></label>
        <label>Standby (W) <input type="number" value={params.standby_power} onChange={e=>update('standby_power', e.target.value)} /></label>
      </div>

      <div className="card">
        <h3>Elevador & Bater√≠a</h3>
        <label>Potencia elevador (W) <input type="number" value={params.elevator_power} onChange={e=>update('elevator_power', e.target.value)} /></label>
        <label>Eficiencia elevador <input type="number" step="0.01" value={params.elevator_efficiency} onChange={e=>update('elevator_efficiency', e.target.value)} /></label>
        <label>Tiempo elevaci√≥n (s) <input type="number" value={params.elevator_time} onChange={e=>update('elevator_time', e.target.value)} /></label>
        <label>Altura elevaci√≥n (m) <input type="number" step="0.1" value={params.elevator_height} onChange={e=>update('elevator_height', e.target.value)} /></label>
        <label>Energ√≠a bater√≠a (kWh) <input type="number" step="0.1" value={params.battery_energy} onChange={e=>update('battery_energy', e.target.value)} /></label>
        <label>Eficiencia propulsi√≥n <input type="number" step="0.01" value={params.propulsion_efficiency} onChange={e=>update('propulsion_efficiency', e.target.value)} /></label>
      </div>

      <div className="card">
        <h3>Ubicaci√≥n Paquetes</h3>
        <div className="pkgRow">
          <label>A x <input type="number" value={params.ax} onChange={e=>update('ax', e.target.value)} /></label>
          <label>A y <input type="number" value={params.ay} onChange={e=>update('ay', e.target.value)} /></label>
        </div>
        <div className="pkgRow">
          <label>B x <input type="number" value={params.bx} onChange={e=>update('bx', e.target.value)} /></label>
          <label>B y <input type="number" value={params.by} onChange={e=>update('by', e.target.value)} /></label>
        </div>
        <div className="pkgRow">
          <label>C x <input type="number" value={params.cx} onChange={e=>update('cx', e.target.value)} /></label>
          <label>C y <input type="number" value={params.cy} onChange={e=>update('cy', e.target.value)} /></label>
        </div>
      </div>

      <div className="panel-actions">
        <button className="primary" onClick={onStart}>üöÄ Iniciar Simulaci√≥n</button>
        <button className="muted" onClick={onReset}>üîÑ Reset</button>
      </div>

      <div style={{marginTop:12}}>
        <label>Velocidad animaci√≥n <input type="range" min="0.05" max="2.0" step="0.05" value={speedScale} onChange={e=>setSpeedScale(Number(e.target.value))} /></label>
        <div style={{fontSize:13,color:'var(--muted)'}}>Escala tiempo: <span className="badge">{speedScale}√ó</span></div>
      </div>

      <div className="note" style={{marginTop:12,color:'var(--muted)'}}>
        Consejo: baja la escala para ver la animaci√≥n lenta y entender las fases de movimiento.
      </div>
    </aside>
  );
}

function MapCanvas({ routePoints, robotPos, boxes, onSvgClick }){
  // compute bounds
  const xs = [0].concat(routePoints.map(p=>p.x));
  const ys = [0].concat(routePoints.map(p=>p.y));
  const minX = Math.min(...xs)-10, maxX = Math.max(...xs)+10;
  const minY = Math.min(...ys)-10, maxY = Math.max(...ys)+10;
  const viewBox = `${minX} ${minY} ${maxX-minX} ${maxY-minY}`;

  return (
    <div className="panel panel-center">
      <h2>üó∫Ô∏è Mapa del Almac√©n (Animaci√≥n)</h2>
      <div className="card canvasWrap" style={{padding:0}}>
        <svg className="svgCanvas" viewBox={viewBox} preserveAspectRatio="xMidYMid meet" onClick={onSvgClick}>
          <defs>
            <linearGradient id="bgGrad" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0" stopColor="#eef7ff"/>
              <stop offset="1" stopColor="#ffffff"/>
            </linearGradient>
          </defs>
          <rect x={minX} y={minY} width={maxX-minX} height={maxY-minY} fill="url(#bgGrad)" rx="8" ry="8"/>

          {routePoints.length>0 && <polyline points={routePoints.map(p=>`${p.x},${p.y}`).join(' ')} fill="none" stroke="#60a5fa" strokeWidth="0.8" strokeDasharray="6 4" />}

          <g>
            <circle cx={0} cy={0} r={2.8} fill="#10b981" stroke="#065f46" strokeWidth="0.2"/>
            <text x={2.5} y={-2.5} fontSize="2.1" fill="#042b4a">Base (0,0)</text>
          </g>

          {boxes.map((b, i)=>(
            <g key={b.name} transform={`translate(${b.x},${b.y})`}>
              <rect x={-1.6} y={-1.6} width={3.2} height={3.2} fill={b.picked ? '#fde68a' : '#ffb4a2'} stroke={b.picked ? '#f97316' : '#ef4444'} strokeWidth="0.12" rx="0.25" />
              <text x={-0.9} y={-2.8} fontSize="1.6" fill="#042b4a">{b.name}</text>
            </g>
          ))}

          <g className="robot-animated" style={{transform: `translate(${robotPos.x}px, ${robotPos.y}px)`}}>
            <circle cx={0} cy={0} r={1.8} fill="#2563eb" stroke="#1e40af" strokeWidth="0.18" />
            <text x={-1.2} y={0.6} fontSize="1.8" fill="#fff">AGV</text>
          </g>
        </svg>
      </div>

      <div className="animInfo">
        <div><strong>Estado:</strong> <span id="animState">Inactivo</span></div>
        <div><strong>Tramo actual:</strong> <span id="currentLeg">‚Äî</span></div>
        <div><strong>Progreso:</strong> <span id="progress">0%</span></div>
      </div>
    </div>
  );
}

function ResultsPanel({ plan, params }){
  const chartRef = useRef(null);
  const chartInstanceRef = useRef(null);

  useEffect(() => {
    if(!plan) return;
    const totals = plan.segments.reduce((acc,s)=>{
      acc.dist += s.dist;
      acc.time += s.time;
      acc.accel += s.e_accel*1000;
      acc.cruise += s.e_cruise*1000;
      acc.brake += s.e_brake*1000;
      acc.elev += s.e_elev*1000;
      acc.standby += s.e_standby*1000;
      acc.wh += s.e_total*1000;
      return acc;
    }, {dist:0,time:0,accel:0,cruise:0,brake:0,elev:0,standby:0,wh:0});

    const ctx = chartRef.current.getContext('2d');
    if(chartInstanceRef.current) chartInstanceRef.current.destroy();
    const categories = ['Aceleraci√≥n','Crucero','Frenado','Elevador','Standby'];
    const data = [totals.accel, totals.cruise, totals.brake, totals.elev, totals.standby];
    chartInstanceRef.current = new Chart(ctx, {
      type:'bar',
      data:{
        labels: categories,
        datasets:[{
          label:'Energ√≠a (Wh)',
          data: data,
          backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'],
          borderRadius:8
        }]
      },
      options:{
        responsive:true,
        plugins:{legend:{display:false}, title:{display:true,text:'Distribuci√≥n Energ√©tica',font:{size:14}}},
        scales:{y:{beginAtZero:true, title:{display:true,text:'Wh'}}}
      }
    });

    return ()=>{ if(chartInstanceRef.current) chartInstanceRef.current.destroy(); };
  }, [plan]);

  if(!plan) return (
    <aside className="panel panel-right">
      <h2>üìä Resultados</h2>
      <div className="card">Ejecuta la simulaci√≥n para ver resultados.</div>
    </aside>
  );

  const totalWh = plan.totalEnergy*1000;
  const batteryUsed = (plan.totalEnergy / params.battery_energy) * 100;

  return (
    <aside className="panel panel-right">
      <h2>üìä Resultados</h2>

      <div className="card resultsCard">
        <div id="summary">
          <p><b>Ruta √≥ptima:</b> {plan.segments.map(s=>s.from).join(' ‚Üí ')} ‚Üí Base</p>
          <p><b>Energ√≠a total:</b> {totalWh.toFixed(2)} Wh ({plan.totalEnergy.toFixed(5)} kWh)</p>
          <p><b>Bater√≠a restante:</b> {(100 - batteryUsed).toFixed(2)}%</p>
        </div>
      </div>

      <div className="card">
        <h3>‚öôÔ∏è Par√°metros F√≠sica</h3>
        <div id="physics">
          {(() => {
            const m_total = params.mass_robot + params.mass_package;
            const phys = calcPhysics(m_total, params);
            const elevE = calcElevatorEnergy(params);
            return (
              <div>
                <p>Fuerza de fricci√≥n: {phys.friction.toFixed(2)} N</p>
                <p>Fuerza tracci√≥n (acelerar): {phys.tractionAccel.toFixed(2)} N</p>
                <p>Fuerza tracci√≥n (constante): {phys.tractionConst.toFixed(2)} N</p>
                <p>Potencia requerida (acelerar): {phys.powerAccel.toFixed(2)} W</p>
                <p>Potencia requerida (crucero): {phys.powerConst.toFixed(2)} W</p>
                <p>Energ√≠a elevador (por elevaci√≥n): {(elevE*1000).toFixed(3)} Wh</p>
              </div>
            );
          })()}
        </div>
      </div>

      <div className="card">
        <h3>üìã Desglose por Tramo</h3>
        <div style={{overflow:'auto',maxHeight:220}}>
          <table>
            <thead><tr><th>Tramo</th><th>Dist (m)</th><th>Tiempo (s)</th><th>Total (Wh)</th></tr></thead>
            <tbody>
              {plan.segments.map((s, i)=>(
                <tr key={i}>
                  <td>{s.from} ‚Üí {s.to}</td>
                  <td>{s.dist.toFixed(2)}</td>
                  <td>{s.time.toFixed(2)}</td>
                  <td>{(s.e_total*1000).toFixed(2)}</td>
                </tr>
              ))}
            </tbody>
            <tfoot>
              <tr><td><b>TOTAL</b></td><td><b>{plan.segments.reduce((a,s)=>a+s.dist,0).toFixed(2)}</b></td><td><b>{plan.segments.reduce((a,s)=>a+s.time,0).toFixed(2)}</b></td><td><b>{(plan.totalEnergy*1000).toFixed(2)}</b></td></tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div className="card">
        <h3>üìà Distribuci√≥n Energ√©tica</h3>
        <canvas ref={chartRef} height="140"></canvas>
      </div>
    </aside>
  );
}

/* ---------- Top-level App ---------- */
function App(){
  const [params, setParams] = useState({
    mass_robot:300, mass_package:50, max_velocity:2, max_acceleration:0.5,
    friction_coeff:0.07, standby_power:100,
    elevator_power:1500, elevator_efficiency:0.9, elevator_time:3, elevator_height:1.5,
    battery_energy:1.5, propulsion_efficiency:0.85,
    ax:20, ay:50, bx:60, by:30, cx:40, cy:10
  });

  const [plan, setPlan] = useState(null);
  const [routePoints, setRoutePoints] = useState([]);
  const [robotPos, setRobotPos] = useState({x:0,y:0});
  const [boxes, setBoxes] = useState([]);
  const [speedScale, setSpeedScale] = useState(0.45);
  const animStateRef = useRef({running:false});

  useEffect(()=> {
    setBoxes([
      {name:'A', x:params.ax, y:params.ay, picked:false},
      {name:'B', x:params.bx, y:params.by, picked:false},
      {name:'C', x:params.cx, y:params.cy, picked:false}
    ]);
  }, []);

  async function prepareSimulation(localParams){
    const p = localParams || params;
    const pkgs = [
      {name:'A', x:p.ax, y:p.ay},
      {name:'B', x:p.bx, y:p.by},
      {name:'C', x:p.cx, y:p.cy}
    ];
    function dist(a,b){ return Math.hypot(b.x-a.x, b.y-a.y); }
    const base = {name:'Base', x:0, y:0};
    const perms = permutations([0,1,2]);
    let best = null, bestE = Infinity, bestSegs = null;
    for(const perm of perms){
      let pos = base; let mass = p.mass_robot; let segs=[]; let totalE=0;
      for(let i=0;i<perm.length;i++){
        const pkg = pkgs[perm[i]];
        const d = dist(pos,pkg);
        const seg = calcSegment(d, mass, p);
        const elevE = calcElevatorEnergy(p);
        const segTotal = seg.e_accel + seg.e_cruise + seg.e_brake + seg.e_standby + elevE;
        segs.push({from:pos.name, to:pkg.name, x:pkg.x, y:pkg.y, dist:d, time:seg.totalTime, e_accel:seg.e_accel, e_cruise:seg.e_cruise, e_brake:seg.e_brake, e_standby:seg.e_standby, e_elev:elevE, e_total:segTotal});
        totalE += segTotal;
        pos = pkg; mass += p.mass_package;
      }
      const dback = dist(pos, base);
      const segBack = calcSegment(dback, mass, p);
      const backTotal = segBack.e_accel + segBack.e_cruise + segBack.e_brake + segBack.e_standby;
      segs.push({from:pos.name, to:'Base', x:0, y:0, dist:dback, time:segBack.totalTime, e_accel:segBack.e_accel, e_cruise:segBack.e_cruise, e_brake:segBack.e_brake, e_standby:segBack.e_standby, e_elev:0, e_total:backTotal});
      totalE += backTotal;
      if(totalE < bestE){ bestE = totalE; best = perm; bestSegs = segs; }
    }
    return {params:p, packages:pkgs, segments:bestSegs, totalEnergy:bestE};
  }

  async function onStart() {
  if (animStateRef.current.running) return;
  animStateRef.current.running = true;
  document.getElementById('animState').innerText = 'Animando...';

  // Prepara el plan sin pausas intermedias
  const planLocal = await prepareSimulation(params);
  setPlan(planLocal);

  const route = [{x:0,y:0}, ...planLocal.segments.map(s=>({x:s.x,y:s.y})), {x:0,y:0}];
  setRoutePoints(route);

  // Reinicia posiciones y cajas
  setRobotPos({x:0,y:0});
  setBoxes(planLocal.packages.map(p=>({...p, picked:false})));

  // üí° Empieza a animar de inmediato (sin esperar un render adicional)
  setTimeout(() => {
    runSequence(planLocal).then(() => {
      document.getElementById('animState').innerText = 'Finalizado';
      animStateRef.current.running = false;
    });
  }, 100);
}


  function onReset(){
    animStateRef.current.running = false;
    setPlan(null);
    setRoutePoints([]);
    setRobotPos({x:0,y:0});
    setBoxes([
      {name:'A', x:params.ax, y:params.ay, picked:false},
      {name:'B', x:params.bx, y:params.by, picked:false},
      {name:'C', x:params.cx, y:params.cy, picked:false}
    ]);
    document.getElementById('animState') && (document.getElementById('animState').innerText = 'Inactivo');
    document.getElementById('currentLeg') && (document.getElementById('currentLeg').innerText = '‚Äî');
    document.getElementById('progress') && (document.getElementById('progress').innerText = '0%');
  }

  async function runSequence(planLocal){
    const segments = planLocal.segments;
    const total = segments.length;
    for(let i=0;i<segments.length;i++){
      const s = segments[i];
      const target = {x: s.x, y: s.y};
      document.getElementById('currentLeg').innerText = `${s.from} ‚Üí ${s.to}`;
      const animSeconds = Math.max(0.4, s.time * speedScale);
      setRobotPos(target);
      await new Promise(res => setTimeout(res, Math.round(animSeconds*1000)));
      if(s.to !== 'Base'){
        setBoxes(prev => prev.map(b => b.name === s.to ? {...b, picked:true} : b));
        await new Promise(res=>setTimeout(res, 220));
      }
      const prog = Math.round(((i+1)/total)*100);
      document.getElementById('progress').innerText = `${prog}%`;
    }
    setRobotPos({x:0,y:0});
    await new Promise(res=>setTimeout(res,400));
    document.getElementById('progress').innerText = `100%`;
  }

  return (
    <div>
      <div className="layout">
        <Controls params={params} setParams={(p)=>setParams(p)} onStart={onStart} onReset={onReset} speedScale={speedScale} setSpeedScale={setSpeedScale} />
        <MapCanvas routePoints={routePoints.length?routePoints: [{x:params.ax,y:params.ay},{x:params.bx,y:params.by},{x:params.cx,y:params.cy},{x:0,y:0}]} robotPos={robotPos} boxes={boxes} />
        <ResultsPanel plan={plan} params={params} />
      </div>
      <footer style={{textAlign:'center',paddingBottom:20}}><small>Versi√≥n React con CSS Animations ‚Äî Prototipo sin build</small></footer>
    </div>
  );
}

/* ---------- Render ---------- */
ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>